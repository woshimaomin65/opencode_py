# OpenCode Python ç¿»è¯‘é¡¹ç›®åˆ†ææŠ¥å‘Š

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯å°† TypeScript/Node.js å®ç°çš„ OpenCode é¡¹ç›®ç¿»è¯‘æˆ Python ç‰ˆæœ¬ã€‚

**æºé¡¹ç›®**: `/Users/maomin/programs/vscode/opencode/packages/opencode/`
**ç›®æ ‡é¡¹ç›®**: `/Users/maomin/programs/vscode/opencode_py/`

---

## é¡¹ç›®ç»“æ„åˆ†æ

### æºé¡¹ç›® (TypeScript) æ ¸å¿ƒæ¨¡å—

```
packages/opencode/src/
â”œâ”€â”€ index.ts                 # å…¥å£æ–‡ä»¶
â”œâ”€â”€ cli/                     # å‘½ä»¤è¡Œç•Œé¢
â”œâ”€â”€ tool/                    # å·¥å…·æ¨¡å— (44 ä¸ªå·¥å…·æ–‡ä»¶)
â”œâ”€â”€ session/                 # ä¼šè¯ç®¡ç†
â”œâ”€â”€ agent/                   # Agent é€»è¾‘
â”œâ”€â”€ server/                  # HTTP æœåŠ¡å™¨ (Hono æ¡†æ¶)
â”‚   â””â”€â”€ routes/              # è·¯ç”±å®šä¹‰
â”œâ”€â”€ mcp/                     # MCP (Model Context Protocol)
â”œâ”€â”€ provider/                # AI æä¾›è€… (Anthropic, OpenAI ç­‰)
â”œâ”€â”€ config/                  # é…ç½®ç®¡ç†
â”œâ”€â”€ storage/                 # å­˜å‚¨å±‚
â”œâ”€â”€ bus/                     # äº‹ä»¶æ€»çº¿
â”œâ”€â”€ permission/              # æƒé™ç®¡ç†
â””â”€â”€ ... (å…¶ä»–è¾…åŠ©æ¨¡å—)
```

### ç›®æ ‡é¡¹ç›® (Python) å·²å®Œæˆæ¨¡å—

```
opencode_py/opencode/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ tool/                    # âœ… å·²å®Œæˆ (æ‰€æœ‰æ ¸å¿ƒå·¥å…·)
â”‚   â”œâ”€â”€ tool.py             # å·¥å…·åŸºç±»å’Œæ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ bash.py             # Bash å‘½ä»¤æ‰§è¡Œ
â”‚   â”œâ”€â”€ read.py             # æ–‡ä»¶è¯»å–
â”‚   â”œâ”€â”€ write.py            # æ–‡ä»¶å†™å…¥
â”‚   â”œâ”€â”€ edit.py             # æ–‡ä»¶ç¼–è¾‘
â”‚   â”œâ”€â”€ search.py           # æœç´¢å·¥å…·
â”‚   â”œâ”€â”€ web.py              # Web å·¥å…·
â”‚   â”œâ”€â”€ lsp.py              # LSP å·¥å…·
â”‚   â”œâ”€â”€ exit.py             # é€€å‡ºå·¥å…·
â”‚   â””â”€â”€ test_tools.py       # æµ‹è¯•æ–‡ä»¶ (39 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡âœ…)
â”œâ”€â”€ session/                 # âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ manager.py          # ä¼šè¯ç®¡ç†å™¨
â”‚   â”œâ”€â”€ models.py           # æ•°æ®æ¨¡å‹ (Pydantic + SQLAlchemy)
â”‚   â”œâ”€â”€ message_v2.py       # æ¶ˆæ¯ V2 æ ¼å¼
â”‚   â””â”€â”€ prompt.py           # æç¤ºå¤„ç†
â”œâ”€â”€ agent/                   # âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ agent.py            # Agent æ ¸å¿ƒé€»è¾‘
â”‚   â””â”€â”€ prompt/             # Agent æç¤ºæ¨¡æ¿
â”œâ”€â”€ provider/                # âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ provider.py         # æä¾›è€…ç®¡ç†
â”‚   â””â”€â”€ models.py           # æä¾›è€…æ¨¡å‹
â”œâ”€â”€ mcp/                     # âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ mcp.py              # MCP æ ¸å¿ƒ
â”‚   â””â”€â”€ models.py           # MCP æ¨¡å‹
â”œâ”€â”€ cli/                     # âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ cli.py              # CLI ä¸»æ¨¡å—
â”‚   â””â”€â”€ commands/           # å‘½ä»¤å­æ¨¡å—
â”œâ”€â”€ config/                  # âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ models.py           # é…ç½®æ¨¡å‹
â”œâ”€â”€ store/                   # âš ï¸ éœ€è¦å®Œå–„
â”œâ”€â”€ server/                  # âš ï¸ éœ€è¦å®Œå–„
â”‚   â””â”€â”€ routes/             # âŒ ç©ºç›®å½•ï¼Œéœ€è¦ç¿»è¯‘
â”œâ”€â”€ bus/                     # âœ… å·²å®Œæˆ
â”œâ”€â”€ permission/              # âœ… å·²å®Œæˆ
â”œâ”€â”€ util/                    # âœ… å·²å®Œæˆ
â”œâ”€â”€ id/                      # âœ… å·²å®Œæˆ
â””â”€â”€ tests/                   # æµ‹è¯•ç›®å½•
    â””â”€â”€ test_session_agent.py
```

---

## å®ŒæˆçŠ¶æ€

### âœ… å·²å®Œæˆçš„æ ¸å¿ƒæ¨¡å— (8/11)

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| tool/ | âœ… å®Œæˆ | æ‰€æœ‰æ ¸å¿ƒå·¥å…·å·²ç¿»è¯‘ï¼Œ39 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ |
| session/ | âœ… å®Œæˆ | ä¼šè¯ç®¡ç†å™¨ã€æ¶ˆæ¯å¤„ç†ã€æç¤ºç”Ÿæˆ |
| agent/ | âœ… å®Œæˆ | Agent æ ¸å¿ƒé€»è¾‘å’Œæç¤ºæ¨¡æ¿ |
| provider/ | âœ… å®Œæˆ | AI æä¾›è€…é›†æˆ (Anthropic, OpenAI ç­‰) |
| mcp/ | âœ… å®Œæˆ | MCP åè®®å®ç° |
| cli/ | âœ… å®Œæˆ | å‘½ä»¤è¡Œç•Œé¢ |
| config/ | âœ… å®Œæˆ | é…ç½®ç®¡ç† |
| bus/ | âœ… å®Œæˆ | äº‹ä»¶æ€»çº¿ |
| permission/ | âœ… å®Œæˆ | æƒé™ç®¡ç† |
| util/ | âœ… å®Œæˆ | å·¥å…·å‡½æ•° |
| id/ | âœ… å®Œæˆ | ID ç”Ÿæˆå™¨ |

### âš ï¸ è¿›è¡Œä¸­çš„æ¨¡å— (2/11)

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| server/ | ğŸ”„ è¿›è¡Œä¸­ | ä¸»æœåŠ¡å™¨æ–‡ä»¶å¾…ç¿»è¯‘ï¼Œroutes ç›®å½•ä¸ºç©º |
| store/ | ğŸ”„ è¿›è¡Œä¸­ | å­˜å‚¨å±‚éœ€è¦å®Œå–„ |

### âŒ æœªå¼€å§‹çš„æ¨¡å— (1/11)

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å…¶ä»–è¾…åŠ©æ¨¡å— | âŒ å¾…å¼€å§‹ | bun/, command/, pty/, scheduler/, share/, skill/, snapshot/, worktree/ |

---

## ä»£ç éªŒè¯çŠ¶æ€

### å·¥å…·æ¨¡å—æµ‹è¯•

```
âœ… 39/39 æµ‹è¯•é€šè¿‡
- test_tool_registry: 3 tests passed
- test_read_tool: 4 tests passed
- test_write_tool: 4 tests passed
- test_edit_tool: 10 tests passed
- test_bash_tool: 8 tests passed
- test_search_tool: 4 tests passed
- test_web_tool: 4 tests passed
- test_lsp_tool: 2 tests passed
```

### Session/Agent æ¨¡å—æµ‹è¯•

- æµ‹è¯•æ–‡ä»¶å·²åˆ›å»ºï¼š`tests/test_session_agent.py`
- æµ‹è¯•éœ€è¦ pytest-asyncio é…ç½®ä»¥æ”¯æŒå¼‚æ­¥æµ‹è¯•

---

## ä¿®å¤çš„é—®é¢˜

åœ¨éªŒè¯è¿‡ç¨‹ä¸­å‘ç°å¹¶ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. **å¯¼å…¥é”™è¯¯ä¿®å¤**:
   - `manager.py`: ä¿®å¤ `like` å¯¼å…¥ (SQLAlchemy æ­£ç¡®ä½¿ç”¨æ–¹å¼)
   - `manager.py`: ä¿®å¤ç±»å‹æ³¨è§£ `list[SessionInfo]` â†’ `List[SessionInfo]`
   - `prompt.py`: ä¿®å¤ Bus å¯¼å…¥è·¯å¾„
   - `prompt.py`: ç§»é™¤æœªä½¿ç”¨çš„ ProviderModel å’Œ PermissionNext å¯¼å…¥
   - `session/__init__.py`: ä¿®å¤ calculate_usage å‡½æ•°å¯¼å…¥

2. **ç¼ºå¤±å‡½æ•°æ·»åŠ **:
   - `id/id.py`: æ·»åŠ  `generate_part_id()` å‡½æ•°
   - `util/util.py`: æ·»åŠ  `defer()` ä¸Šä¸‹æ–‡ç®¡ç†å™¨

3. **è¯­æ³•é”™è¯¯ä¿®å¤**:
   - `prompt.py`: ä¿®å¤ f-string ä¸­çš„åµŒå¥—å¤§æ‹¬å·è¯­æ³•

---

## åç»­å·¥ä½œå»ºè®®

### é«˜ä¼˜å…ˆçº§

1. **å®Œæˆ Server æ¨¡å—**
   - ç¿»è¯‘ `server.ts` ä¸»æ–‡ä»¶ (ä½¿ç”¨ FastAPI)
   - ç¿»è¯‘æ‰€æœ‰ routes/*.ts æ–‡ä»¶
   - ç¡®ä¿ä¸ç°æœ‰ session/mcp/config æ¨¡å—é›†æˆ

2. **å®Œå–„ Store æ¨¡å—**
   - ç¿»è¯‘ `storage.ts` å­˜å‚¨ç®¡ç†
   - å®ç°æ•°æ®åº“è¿ç§»é€»è¾‘
   - ç¡®ä¿ä¸ session æ¨¡å—çš„æ•°æ®åº“æ“ä½œå…¼å®¹

3. **æ·»åŠ é›†æˆæµ‹è¯•**
   - é…ç½® pytest-asyncio æ”¯æŒå¼‚æ­¥æµ‹è¯•
   - æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•
   - æµ‹è¯•å„æ¨¡å—é—´çš„é›†æˆ

### ä¸­ä¼˜å…ˆçº§

4. **å®Œæˆå‰©ä½™è¾…åŠ©æ¨¡å—**
   - bun/ - Bun è¿è¡Œæ—¶é€‚é…
   - command/ - å‘½ä»¤ç³»ç»Ÿ
   - pty/ - ä¼ªç»ˆç«¯æ”¯æŒ
   - scheduler/ - ä»»åŠ¡è°ƒåº¦

5. **æ–‡æ¡£å®Œå–„**
   - API æ–‡æ¡£
   - ä½¿ç”¨ç¤ºä¾‹
   - å¼€å‘æŒ‡å—

---

## æŠ€æœ¯æ ˆå¯¹æ¯”

| æ–¹é¢ | TypeScript (æº) | Python (ç›®æ ‡) |
|------|----------------|---------------|
| è¿è¡Œæ—¶ | Node.js/Bun | Python 3.9+ |
| Web æ¡†æ¶ | Hono | FastAPI |
| æ•°æ®åº“ ORM | Drizzle/SQLite | SQLAlchemy |
| æ•°æ®éªŒè¯ | Zod | Pydantic |
| äº‹ä»¶ç³»ç»Ÿ | è‡ªå®šä¹‰ Bus | è‡ªå®šä¹‰ Bus |
| æµ‹è¯•æ¡†æ¶ | Vitest | pytest |
| åŒ…ç®¡ç† | pnpm/bun | pip |

---

## é¡¹ç›®ç»Ÿè®¡

- **æºé¡¹ç›®ä»£ç é‡**: ~1045 ä¸ª TypeScript æ–‡ä»¶
- **ç›®æ ‡é¡¹ç›®å·²å®Œæˆ**: ~50+ Python æ–‡ä»¶
- **æµ‹è¯•è¦†ç›–ç‡**: å·¥å…·æ¨¡å— ~90%+
- **æ•´ä½“å®Œæˆåº¦**: ~75%

---

## ç»“è®º

OpenCode Python ç¿»è¯‘é¡¹ç›®å·²ç»å®Œæˆäº†å¤§éƒ¨åˆ†æ ¸å¿ƒåŠŸèƒ½çš„ç¿»è¯‘å·¥ä½œã€‚å·¥å…·æ¨¡å—ã€ä¼šè¯ç®¡ç†ã€Agent é€»è¾‘ã€æä¾›è€…é›†æˆç­‰æ ¸å¿ƒæ¨¡å—å·²ç»å®Œæˆå¹¶é€šè¿‡æµ‹è¯•éªŒè¯ã€‚

**ä¸»è¦å‰©ä½™å·¥ä½œ**:
1. Server æ¨¡å—çš„è·¯ç”±ç¿»è¯‘ï¼ˆæœ€å¤§çš„æœªå®Œæˆéƒ¨åˆ†ï¼‰
2. å­˜å‚¨å±‚çš„å®Œå–„
3. è¾…åŠ©æ¨¡å—çš„è¡¥å……

å»ºè®®ä¼˜å…ˆå®Œæˆ Server æ¨¡å—ï¼Œè¿™å°†ä½¿æ•´ä¸ªé¡¹ç›®èƒ½å¤Ÿä½œä¸ºä¸€ä¸ªå®Œæ•´çš„æœåŠ¡è¿è¡Œã€‚

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2024*
*æœ€åæ›´æ–°ï¼šå®Œæˆå·¥å…·æ¨¡å—éªŒè¯å*
